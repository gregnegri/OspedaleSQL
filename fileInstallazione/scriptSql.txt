CREATE TABLE PAZIENTE
(
COD_PAZIENTE CHAR(6) PRIMARY KEY,
CF CHAR(16) NOT NULL UNIQUE,
NOME VARCHAR(15) NOT NULL,
COGNOME VARCHAR(15) NOT NULL,
NUM_TEL VARCHAR(13),
DATA_DI_NASCITA DATE NOT NULL,
RESIDENZA VARCHAR(50) NOT NULL,
LUOGO_DI_NASCITA VARCHAR(50) NOT NULL,
FASCICOLO_SANITARIO CHAR(20) UNIQUE
);

CREATE TABLE DIPENDENTE
(
MATRICOLA CHAR(6) PRIMARY KEY,
CF CHAR(16) NOT NULL UNIQUE,
NOME VARCHAR(15) NOT NULL,
COGNOME VARCHAR(15) NOT NULL,
NUM_TEL VARCHAR(13),
DATA_DI_NASCITA DATE NOT NULL,
RESIDENZA VARCHAR(50) NOT NULL,
LUOGO_DI_NASCITA VARCHAR(50) NOT NULL,
CURRICULUM VARCHAR
);

CREATE TABLE EQUIPE
(
CODICE_EQUIPE CHAR(6) PRIMARY KEY
);

CREATE TABLE DISPOSITIVO_MEDICO
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
ATTIVO BOOLEAN NOT NULL,
CLASSE CHAR(10) NOT NULL,
DESCRIZIONE VARCHAR,
PRIMARY KEY(CODICE_CND,CODICE_SERIALE)
);



CREATE TABLE TIPOLOGIA_INTERVENTO
(
DENOMINAZIONE CHAR(25) PRIMARY KEY,
DESCRIZIONE VARCHAR
);

CREATE TABLE MALATTIA
(
COD_ICD10 CHAR(5) PRIMARY KEY,
NOME VARCHAR(150) NOT NULL
);

CREATE TABLE MEDICINA
(
COD_AIC CHAR(9) PRIMARY KEY,
COD_ATC CHAR(7) NOT NULL,
NOME VARCHAR(50) NOT NULL,
FASCIA_SSN CHAR(1) NOT NULL,
DESCRIZIONE VARCHAR
);

CREATE TABLE LABORATORIO
(
CODICE_LAB CHAR(4) PRIMARY KEY,
NOME_LAB VARCHAR(50) NOT NULL
);

CREATE TABLE SALA
( 
CODICE_SALA CHAR(3) PRIMARY KEY,
NOME_SALA VARCHAR(25) NOT NULL,
DESCRIZIONE_SALA VARCHAR
); 

CREATE TABLE SALA_OPERATORIA
(
CODICE_SALA CHAR(3) PRIMARY KEY,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA ON DELETE CASCADE ON UPDATE CASCADE
);




CREATE TABLE SALA_TERAPEUTICA
(
CODICE_SALA CHAR(3) PRIMARY KEY,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE TIPO_TERAPIA
(
NOME_TERAPIA VARCHAR(100) PRIMARY KEY,
DESCRIZIONE VARCHAR
);

CREATE TABLE ABILITATA_A
(
CODICE_SALA CHAR(3),
NOME_TERAPIA VARCHAR(100),
PRIMARY KEY(CODICE_SALA, NOME_TERAPIA),
FOREIGN KEY(NOME_TERAPIA) REFERENCES TIPO_TERAPIA ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA_TERAPEUTICA ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE TERAPIA
(
COD_PAZIENTE CHAR(6),
NOME_TERAPIA VARCHAR(100),
GIORNO_SETT INT CHECK(GIORNO_SETT BETWEEN 1 AND 7),
ORA TIME NOT NULL,
CODICE_SALA CHAR(3) NOT NULL,
PRIMARY KEY(COD_PAZIENTE, NOME_TERAPIA, GIORNO_SETT),
UNIQUE(NOME_TERAPIA, GIORNO_SETT, ORA, CODICE_SALA),
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(NOME_TERAPIA) REFERENCES TIPO_TERAPIA ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA_TERAPEUTICA ON DELETE CASCADE ON UPDATE CASCADE 
);



CREATE TABLE MACCHINARIO
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES DISPOSITIVO_MEDICO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE IMPIANTABILE
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES DISPOSITIVO_MEDICO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE STRUMENTAZIONE
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES DISPOSITIVO_MEDICO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE STRUMENTAZIONE_TERAPEUTICA
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
CODICE_SALA CHAR(3),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES STRUMENTAZIONE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA_TERAPEUTICA ON DELETE SET NULL ON UPDATE CASCADE
);





CREATE TABLE STRUMENTAZIONE_CHIRURGICA
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
CODICE_SALA CHAR(3),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES STRUMENTAZIONE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA_OPERATORIA ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE TABLE INFERMIERE
(
MATRICOLA CHAR(6) PRIMARY KEY,
FOREIGN KEY(MATRICOLA) REFERENCES DIPENDENTE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE TERAPISTA
(
MATRICOLA CHAR(6) PRIMARY KEY,
TITOLO VARCHAR(50) NOT NULL,
FOREIGN KEY(MATRICOLA) REFERENCES DIPENDENTE ON DELETE CASCADE ON UPDATE CASCADE
);

















CREATE TABLE INTERVENTO
(
DATA DATE,
CODICE_EQUIPE CHAR(6),
COD_PAZIENTE CHAR(6) NOT NULL,
CODICE_SALA CHAR(3) NOT NULL,
FASCIA_ORARIA INT NOT NULL CHECK(FASCIA_ORARIA BETWEEN 1 AND 2),
COD_INTERVENTO CHAR(6) NOT NULL UNIQUE,
DESCRIZIONE VARCHAR,
DENOM_TIPO CHAR(25),
PRIMARY KEY(DATA, CODICE_EQUIPE),
UNIQUE(DATA, COD_PAZIENTE),
UNIQUE(DATA, FASCIA_ORARIA, CODICE_SALA),
FOREIGN KEY(CODICE_EQUIPE) REFERENCES EQUIPE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_SALA) REFERENCES SALA_OPERATORIA ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(DENOM_TIPO) REFERENCES TIPOLOGIA_INTERVENTO,
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE LISTA_DATTESA
(
CODICE_LISTA CHAR(6) PRIMARY KEY,
DENOM_TIPO CHAR(25),
FOREIGN KEY(DENOM_TIPO) REFERENCES TIPOLOGIA_INTERVENTO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE INSERITO
(
COD_PAZIENTE CHAR(6),
CODICE_LISTA CHAR(6),
DATA_INS DATE NOT NULL,
PRIMARY KEY(COD_PAZIENTE, CODICE_LISTA),
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_LISTA) REFERENCES LISTA_DATTESA ON DELETE CASCADE ON UPDATE CASCADE
);


CREATE TABLE REPARTO
(
COD_REPARTO CHAR(2) PRIMARY KEY,
NOME_REPARTO VARCHAR NOT NULL
);

CREATE TABLE MEDICO
(
MATRICOLA CHAR(6) PRIMARY KEY,
ORARIO_DI_LAVORO VARCHAR,
COD_REPARTO CHAR(2),
FOREIGN KEY(COD_REPARTO) REFERENCES REPARTO,
FOREIGN KEY(MATRICOLA) REFERENCES DIPENDENTE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE AMBULATORIO
(
COD_AMB CHAR(6) PRIMARY KEY,
NOME_AMB VARCHAR NOT NULL,
TIPO CHAR(25),
CODICE_REPARTO CHAR(6),
FOREIGN KEY(CODICE_REPARTO) REFERENCES REPARTO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE E_PRIMARIO_DI
(
COD_REPARTO CHAR(2) PRIMARY KEY,
MATRICOLA CHAR(6),
FOREIGN KEY(COD_REPARTO) REFERENCES REPARTO ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(MATRICOLA) REFERENCES MEDICO ON DELETE CASCADE ON UPDATE CASCADE
);








CREATE TABLE E_CAPOREPARTO_DI
(
COD_REPARTO CHAR(2) PRIMARY KEY,
MATRICOLA CHAR(6),
FOREIGN KEY(COD_REPARTO) REFERENCES REPARTO ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(MATRICOLA) REFERENCES INFERMIERE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE SPECIALIZZAZIONE
(
MATRICOLA CHAR(6),
NUM_SPEC INT,
DESCRIZIONE VARCHAR,
PRIMARY KEY(MATRICOLA, NUM_SPEC),
FOREIGN KEY(MATRICOLA) REFERENCES MEDICO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE VISITA
(
CODICE_VISITA CHAR(6) PRIMARY KEY,
DATA_ORA TIMESTAMP NOT NULL,
COD_AMB CHAR(6) NOT NULL,
COD_PAZIENTE CHAR(6) NOT NULL,
DESCRIZIONE VARCHAR,
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_AMB) REFERENCES AMBULATORIO ON DELETE CASCADE ON UPDATE CASCADE,
UNIQUE(DATA_ORA, COD_PAZIENTE),
UNIQUE(DATA_ORA, COD_AMB)
);

CREATE TABLE CORSIA
(
COD_REPARTO CHAR(2),
CODICE_CORSIA CHAR(2),
PRIMARY KEY(COD_REPARTO, CODICE_CORSIA),
FOREIGN KEY(COD_REPARTO) REFERENCES REPARTO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE STANZA
(
COD_REPARTO CHAR(2),
CODICE_CORSIA CHAR(2),
NUM_STANZA INT,
PRIMARY KEY(COD_REPARTO, CODICE_CORSIA, NUM_STANZA),
FOREIGN KEY(COD_REPARTO, CODICE_CORSIA) REFERENCES CORSIA(COD_REPARTO, CODICE_CORSIA) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE LETTO
(
COD_REPARTO CHAR(2),
CODICE_CORSIA CHAR(2),
NUM_STANZA INT,
NUM_LETTO INT,
PRIMARY KEY(COD_REPARTO, CODICE_CORSIA, NUM_STANZA, NUM_LETTO),
FOREIGN KEY(COD_REPARTO, CODICE_CORSIA, NUM_STANZA) REFERENCES STANZA(COD_REPARTO, CODICE_CORSIA, NUM_STANZA) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE TURNO
(
MATRICOLA CHAR(6),
GIORNO_SETT INT CHECK(GIORNO_SETT BETWEEN 1 AND 7),
DESCRIZIONE VARCHAR,
COD_REPARTO CHAR(2),
CODICE_CORSIA CHAR(2),
PRIMARY KEY(MATRICOLA, GIORNO_SETT),
FOREIGN KEY(MATRICOLA) REFERENCES INFERMIERE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_REPARTO, CODICE_CORSIA) REFERENCES CORSIA(COD_REPARTO, CODICE_CORSIA) ON DELETE CASCADE ON UPDATE CASCADE
);





CREATE TABLE SI_OCCUPA_DI
(
MATRICOLA CHAR(6) PRIMARY KEY,
COD_AMB CHAR(6),
FOREIGN KEY(MATRICOLA) REFERENCES MEDICO ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_AMB) REFERENCES AMBULATORIO ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE CHIRURGHI_IN
(
MATRICOLA CHAR(6) PRIMARY KEY,
CODICE_EQUIPE CHAR(6),
FOREIGN KEY(MATRICOLA) REFERENCES MEDICO ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_EQUIPE) REFERENCES EQUIPE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE STRUMENTISTI_IN
(
MATRICOLA CHAR(6) PRIMARY KEY,
CODICE_EQUIPE CHAR(6),
FOREIGN KEY(MATRICOLA) REFERENCES INFERMIERE ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(CODICE_EQUIPE) REFERENCES EQUIPE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE ESEGUE
(
MATRICOLA CHAR(6) PRIMARY KEY,
COD_PAZIENTE CHAR(6),
NOME_TERAPIA VARCHAR(100),
GIORNO_SETT INT CHECK(GIORNO_SETT BETWEEN 1 AND 7),
FOREIGN KEY(MATRICOLA) REFERENCES TERAPISTA ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_PAZIENTE, NOME_TERAPIA, GIORNO_SETT) REFERENCES TERAPIA(COD_PAZIENTE, NOME_TERAPIA, GIORNO_SETT) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE PAZIENTE_RICOVERATO
(
COD_PAZIENTE CHAR(6) PRIMARY KEY,
DATA_RICOVERO DATE NOT NULL,
NOTA VARCHAR,
MATRICOLA CHAR(6) NOT NULL,
COD_REPARTO CHAR(2),
CODICE_CORSIA CHAR(2),
NUM_STANZA INT,
NUM_LETTO INT,
FOREIGN KEY(MATRICOLA) REFERENCES MEDICO,
FOREIGN KEY(COD_REPARTO, CODICE_CORSIA, NUM_STANZA, NUM_LETTO) REFERENCES LETTO(COD_REPARTO, CODICE_CORSIA, NUM_STANZA, NUM_LETTO),
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE HA
(
COD_PAZIENTE CHAR(6),
COD_ICD10 CHAR(5),
ANNOTAZIONE VARCHAR,
PRIMARY KEY(COD_PAZIENTE, COD_ICD10),
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE_RICOVERATO ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_ICD10) REFERENCES MALATTIA ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE POSSIEDE
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
COD_PAZIENTE CHAR(6),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES IMPIANTABILE(CODICE_CND, CODICE_SERIALE) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE_RICOVERATO ON DELETE CASCADE ON UPDATE CASCADE
);


CREATE TABLE PRENDE
(
COD_PAZIENTE CHAR(6),
COD_AIC CHAR(9),
DOSAGGIO VARCHAR(100) NOT NULL,
PRIMARY KEY(COD_PAZIENTE, COD_AIC),
FOREIGN KEY(COD_PAZIENTE) REFERENCES PAZIENTE_RICOVERATO ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_AIC) REFERENCES MEDICINA ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE REFERTO_DI_ESAME
(
CODICE_VISITA CHAR(6),
TIPO_ESAME VARCHAR(150),
DESCRIZIONE VARCHAR NOT NULL,
COD_LAB CHAR(4) NOT NULL,
PRIMARY KEY(CODICE_VISITA, TIPO_ESAME),
FOREIGN KEY(CODICE_VISITA) REFERENCES VISITA ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_LAB) REFERENCES LABORATORIO
);

CREATE TABLE APPARECCHIATURA_SANITARIA
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
COD_AMB CHAR(6),
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES MACCHINARIO(CODICE_CND, CODICE_SERIALE) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_AMB) REFERENCES AMBULATORIO ON DELETE SET NULL ON UPDATE CASCADE
);






CREATE TABLE APPARECCHIATURA_DI_SUPPORTO
(
CODICE_CND CHAR(9),
CODICE_SERIALE CHAR(20),
COD_REPARTO CHAR(2),
CODICE_CORSIA CHAR(2),
NUM_STANZA INT,
NUM_LETTO INT,
PRIMARY KEY(CODICE_CND, CODICE_SERIALE),
FOREIGN KEY(CODICE_CND, CODICE_SERIALE) REFERENCES MACCHINARIO(CODICE_CND, CODICE_SERIALE) ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY(COD_REPARTO, CODICE_CORSIA, NUM_STANZA, NUM_LETTO) REFERENCES LETTO(COD_REPARTO, CODICE_CORSIA, NUM_STANZA, NUM_LETTO) ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE TABLE EQUIVALENTE
(
COD_SOSTITUTO CHAR(9),
COD_SOSTITUENTE CHAR(9),
PRIMARY KEY(COD_SOSTITUTO, COD_SOSTITUENTE),
FOREIGN KEY(COD_SOSTITUTO) REFERENCES MEDICINA,
FOREIGN KEY(COD_SOSTITUENTE) REFERENCES MEDICINA
);

INSERT INTO MEDICINA VALUES('034487013','J01CA06','Bacampicillina ari 12 Cpr 1,2 G','A','La bacampicillina ha dimostrato di essere clinicamente attiva nella terapia di un numero notevole di infezioni dovute a ceppi sensibili di batteri Gram-positivi e Gram-negativi.');
INSERT INTO MEDICINA VALUES('038055012','C08CA01', 'Balarm 28 Cpr 5mg', 'A', 'Balarm è un farmaco a base del principio attivo Amlodipina Besilato, appartenente alla categoria degli Antianginosi, Antipertensivi calcioantagonisti e nello specifico Derivati diidropiridinici.');
INSERT INTO MEDICINA VALUES('03862310','C08CA02','Felodipina ratio 14 Cpr 10mg Rp','A','La felodipina è un calcio-antagonista selettivo a livello vascolare. La felodipina riduce la pressione arteriosa attraverso la riduzione delle resistenza vascolari periferiche');
INSERT INTO MEDICINA VALUES('020121036', 'J01CA01','Amplital 12 Cps 500mg','A','');
INSERT INTO MEDICINA VALUES('042353021', 'N03AF02','Oxcarbazepina tec-50 Cpr 300 mg','A','Anticonvulsionante e stabilizzatore dell umore');

INSERT INTO MEDICINA VALUES('037085089', 'M05BA04','ALENDRONATO*4 cpr 70 mg','A','Utilizzato per rafforzare le ossa, nella terapia e nella prevenzione dell osteoporosi e nella cura della malattia di Paget dell osso');
INSERT INTO MEDICINA VALUES('037461011', 'M05BA04','RALEN*4 cpr riv 70 mg','A','Utilizzato per rafforzare le ossa, nella terapia e nella prevenzione dell osteoporosi e nella cura della malattia di Paget dell osso');
INSERT INTO MEDICINA VALUES('043305061', 'L04AA06','ACIDO MICOFENOLICO*50 cpr gastrores 360mg','A','Farmaco immunosoppressore usato per prevenire il rigetto nel trapianto d organo');
INSERT INTO MEDICINA VALUES('034706257', 'J01MA02', 'CIPROFLOXACINA*10 flaconi EV 200 mg 100 ml', 'H', 'Antibiotico battericida');




INSERT INTO EQUIVALENTE VALUES('020121036','034487013');
INSERT INTO EQUIVALENTE VALUES('038055012','03862310'); 


INSERT INTO EQUIVALENTE VALUES('037085089','037461011');



INSERT INTO DISPOSITIVO_MEDICO VALUES('Z1190','01',FALSE,'','STRUMENTAZIONE VARIA PER BIOIMMAGINI E RADIOTERAPIA');
INSERT INTO DISPOSITIVO_MEDICO VALUES('Z1217','01',FALSE,'I','STRUMENTAZIONE PER EMOTRASFUSIONE');
INSERT INTO DISPOSITIVO_MEDICO VALUES('Z1204','01',FALSE,'I','STRUMENTAZIONE PER MEDICINA GENERALE');
INSERT INTO DISPOSITIVO_MEDICO VALUES('L0101','01',FALSE,'I','BISTURI NON STERILI');
INSERT INTO DISPOSITIVO_MEDICO VALUES('L0315','01',FALSE,'I','DISSETTORI PER CHIRURGIA GENERALE');
INSERT INTO DISPOSITIVO_MEDICO VALUES('J0101','01',TRUE,'I','PACE MAKER');
INSERT INTO DISPOSITIVO_MEDICO VALUES('Z1217','89665842525699975751',FALSE,'I','STRUMENTAZIONE PER EMOTRASFUSIONE');
INSERT INTO DISPOSITIVO_MEDICO VALUES('L010101','0000000000000000001',FALSE,'I','BISTURI CHIRURGICI MONOBLOCCO');
INSERT INTO DISPOSITIVO_MEDICO VALUES('L010101','0000000000000000002',FALSE,'I','BISTURI CHIRURGICI MONOBLOCCO');

INSERT INTO DISPOSITIVO_MEDICO VALUES('Z129006','0000000000000000001',FALSE,'I','PEDANE A NASTRO MOBILE PER USI FISIOTERAPICI E/O DIAGNOSTICI');

INSERT INTO DISPOSITIVO_MEDICO VALUES('Z120690','0000000000000000001',FALSE,'I','STRUMENTAZIONE VARIA FISIOTERAPIA E RIABILITAZIONE');


INSERT INTO DISPOSITIVO_MEDICO VALUES('L0315','02',FALSE,'I','DISSETTORI PER CHIRURGIA GENERALE');


INSERT INTO DISPOSITIVO_MEDICO VALUES('Z11030604','34796847842525562479',TRUE,'I','TOMOGRAFI ASSIALI COMPUTERIZZATI - SUPERIORE O UGUALE A 64 STRATI');
INSERT INTO DISPOSITIVO_MEDICO VALUES('Z11030604','36587598651542556817',TRUE,'I','TOMOGRAFI ASSIALI COMPUTERIZZATI - SUPERIORE O UGUALE A 64 STRATI');


INSERT INTO IMPIANTABILE VALUES('J0101','01');


INSERT INTO STRUMENTAZIONE VALUES('Z1204','01');
INSERT INTO STRUMENTAZIONE VALUES('L0101','01');
INSERT INTO STRUMENTAZIONE VALUES('L0315','01');
INSERT INTO STRUMENTAZIONE VALUES('L0315','02');


INSERT INTO STRUMENTAZIONE VALUES('L010101','0000000000000000001');
INSERT INTO STRUMENTAZIONE VALUES('L010101','0000000000000000002');

INSERT INTO STRUMENTAZIONE VALUES('Z129006','0000000000000000001');
INSERT INTO STRUMENTAZIONE VALUES('Z120690','0000000000000000001');

INSERT INTO SALA VALUES('P37','Sala psicoterapia 1', '');

INSERT INTO SALA_TERAPEUTICA VALUES('P37');

INSERT INTO SALA VALUES('321','Palestra','...');

INSERT INTO SALA_TERAPEUTICA VALUES('321');

INSERT INTO SALA VALUES('123','SALA OPERATORIA 1','...');
INSERT INTO SALA VALUES('135','SALA OPERATORIA 2', '...');
INSERT INTO SALA VALUES('223','SALA OPERATORIA 7', '...');

INSERT INTO SALA_OPERATORIA VALUES('123');
INSERT INTO SALA_OPERATORIA VALUES('135');
INSERT INTO SALA_OPERATORIA VALUES('223');

INSERT INTO SALA VALUES('777', 'SALA POST-OPERATORIA 1', '...');

INSERT INTO STRUMENTAZIONE_TERAPEUTICA VALUES('Z1204','01','321');

INSERT INTO STRUMENTAZIONE_TERAPEUTICA VALUES('Z129006','0000000000000000001','321');
INSERT INTO STRUMENTAZIONE_TERAPEUTICA VALUES('Z120690','0000000000000000001','321');



INSERT INTO STRUMENTAZIONE_CHIRURGICA VALUES('L0101','01','135');
INSERT INTO STRUMENTAZIONE_CHIRURGICA VALUES('L0315','01','123');
INSERT INTO STRUMENTAZIONE_CHIRURGICA VALUES('L010101','0000000000000000001', '123');
INSERT INTO STRUMENTAZIONE_CHIRURGICA VALUES('L010101','0000000000000000002', '135');
INSERT INTO STRUMENTAZIONE_CHIRURGICA VALUES('L0315','02','135');

INSERT INTO MACCHINARIO VALUES('Z1190', '01');
INSERT INTO MACCHINARIO VALUES('Z1217', '01');
INSERT INTO MACCHINARIO VALUES('Z11030604','34796847842525562479');
INSERT INTO MACCHINARIO VALUES('Z11030604','36587598651542556817');
INSERT INTO MACCHINARIO VALUES('Z1217', '89665842525699975751');
INSERT INTO APPARECCHIATURA_SANITARIA VALUES('Z1190','01',NULL);
INSERT INTO APPARECCHIATURA_SANITARIA VALUES('Z11030604','34796847842525562479', NULL);
INSERT INTO APPARECCHIATURA_SANITARIA VALUES('Z11030604','36587598651542556817', NULL);

INSERT INTO APPARECCHIATURA_DI_SUPPORTO VALUES('Z1217','01',NULL,NULL,NULL,NULL);
INSERT INTO APPARECCHIATURA_DI_SUPPORTO VALUES('Z1217','89665842525699975751',NULL,NULL,NULL,NULL);

INSERT INTO REPARTO VALUES('A2','NEUROLOGIA');
INSERT INTO REPARTO VALUES('A1','CARDIOLOGIA');

INSERT INTO CORSIA VALUES('A2','C1');
INSERT INTO CORSIA VALUES('A1','C1');
INSERT INTO CORSIA VALUES('A2','C2');
INSERT INTO CORSIA VALUES('A1','C2');
INSERT INTO CORSIA VALUES('A2','C3');
INSERT INTO CORSIA VALUES('A1','C3');

INSERT INTO STANZA VALUES('A2','C1',1);
INSERT INTO STANZA VALUES('A2','C1',2);
INSERT INTO STANZA VALUES('A2','C1',3);
INSERT INTO STANZA VALUES('A2','C2',1);
INSERT INTO STANZA VALUES('A2','C2',2);
INSERT INTO STANZA VALUES('A2','C2',3);
INSERT INTO STANZA VALUES('A2','C3',1);
INSERT INTO STANZA VALUES('A2','C3',2);
INSERT INTO STANZA VALUES('A2','C3',3);

INSERT INTO STANZA VALUES('A1','C1',1);
INSERT INTO STANZA VALUES('A1','C1',2);
INSERT INTO STANZA VALUES('A1','C1',3);
INSERT INTO STANZA VALUES('A1','C2',1);
INSERT INTO STANZA VALUES('A1','C2',2);
INSERT INTO STANZA VALUES('A1','C2',3);
INSERT INTO STANZA VALUES('A1','C3',1);
INSERT INTO STANZA VALUES('A1','C3',2);
INSERT INTO STANZA VALUES('A1','C3',3);




INSERT INTO LETTO VALUES('A2','C1',1,23);

INSERT INTO LETTO VALUES('A2','C1',1,1);
INSERT INTO LETTO VALUES('A2','C1',2,1);
INSERT INTO LETTO VALUES('A2','C1',3,1);
INSERT INTO LETTO VALUES('A2','C2',1,1);
INSERT INTO LETTO VALUES('A2','C2',2,1);
INSERT INTO LETTO VALUES('A2','C2',3,1);
INSERT INTO LETTO VALUES('A2','C3',1,1);
INSERT INTO LETTO VALUES('A2','C3',2,1);
INSERT INTO LETTO VALUES('A2','C3',3,1);

INSERT INTO LETTO VALUES('A1','C1',1,1);
INSERT INTO LETTO VALUES('A1','C1',2,1);
INSERT INTO LETTO VALUES('A1','C1',3,1);
INSERT INTO LETTO VALUES('A1','C2',1,1);
INSERT INTO LETTO VALUES('A1','C2',2,1);
INSERT INTO LETTO VALUES('A1','C2',3,1);
INSERT INTO LETTO VALUES('A1','C3',1,1);
INSERT INTO LETTO VALUES('A1','C3',2,1);
INSERT INTO LETTO VALUES('A1','C3',3,1);

INSERT INTO LETTO VALUES('A2','C1',1,2);
INSERT INTO LETTO VALUES('A2','C1',2,2);
INSERT INTO LETTO VALUES('A2','C1',3,2);
INSERT INTO LETTO VALUES('A2','C2',1,2);
INSERT INTO LETTO VALUES('A2','C2',2,2);
INSERT INTO LETTO VALUES('A2','C2',3,2);
INSERT INTO LETTO VALUES('A2','C3',1,2);
INSERT INTO LETTO VALUES('A2','C3',2,2);
INSERT INTO LETTO VALUES('A2','C3',3,2);

INSERT INTO LETTO VALUES('A1','C1',1,2);
INSERT INTO LETTO VALUES('A1','C1',2,2);
INSERT INTO LETTO VALUES('A1','C1',3,2);
INSERT INTO LETTO VALUES('A1','C2',1,2);
INSERT INTO LETTO VALUES('A1','C2',2,2);
INSERT INTO LETTO VALUES('A1','C2',3,2);
INSERT INTO LETTO VALUES('A1','C3',1,2);
INSERT INTO LETTO VALUES('A1','C3',2,2);
INSERT INTO LETTO VALUES('A1','C3',3,2);

INSERT INTO LETTO VALUES('A2','C1',1,3);
INSERT INTO LETTO VALUES('A2','C1',2,3);
INSERT INTO LETTO VALUES('A2','C1',3,3);
INSERT INTO LETTO VALUES('A2','C2',1,3);
INSERT INTO LETTO VALUES('A2','C2',2,3);
INSERT INTO LETTO VALUES('A2','C2',3,3);
INSERT INTO LETTO VALUES('A2','C3',1,3);
INSERT INTO LETTO VALUES('A2','C3',2,3);
INSERT INTO LETTO VALUES('A2','C3',3,3);

INSERT INTO LETTO VALUES('A1','C1',1,3);
INSERT INTO LETTO VALUES('A1','C1',2,3);
INSERT INTO LETTO VALUES('A1','C1',3,3);
INSERT INTO LETTO VALUES('A1','C2',1,3);
INSERT INTO LETTO VALUES('A1','C2',2,3);
INSERT INTO LETTO VALUES('A1','C2',3,3);
INSERT INTO LETTO VALUES('A1','C3',1,3);
INSERT INTO LETTO VALUES('A1','C3',2,3);
INSERT INTO LETTO VALUES('A1','C3',3,3);


INSERT INTO DIPENDENTE VALUES('232323', 'RDALSS98P01EERER','Alex','Arduino', '3407155172', '1998-09-01','Iglesias','...');
INSERT INTO DIPENDENTE VALUES('123456', 'ASDASDASDASD','Mauro','Neri', '2312323', '1999-12-02','Vignola','Vignola','...');
INSERT INTO DIPENDENTE VALUES('654321','SDSDSDSDSD','Francesco','Bianchi','2312323', '1999-12-02','Vignola','Vignola','...');
INSERT INTO DIPENDENTE VALUES('135791', 'RTRTRTRTRTT','Leonardo','Cappai', '3407155321', '1998-09-01','Iglesias','Iglesias','...');
INSERT INTO DIPENDENTE VALUES('024680','RDRLSR97P01RERER','Giorgio','Bianchi','346789123','1997-07-01','Modena','Modena','...'); 
INSERT INTO DIPENDENTE VALUES('137876','PSNLSR98P11RERER','Francesco','Pisano','346975912','1998-03-11','Modena','Modena','...');
INSERT INTO DIPENDENTE VALUES('127496','BORRT94P09F257D','Giovanni','Borghi','373544998','1994-06-09','Modena','Modena','...');


INSERT INTO MEDICO VALUES('232323','LUN-VEN 8:00-16:00','A2');
INSERT INTO MEDICO VALUES('135791','LUN-VEN 10:00-18:00','A2'); 
INSERT INTO MEDICO VALUES('024680','LUN-VEN 8:00-16:00','A2');

INSERT INTO PAZIENTE VALUES('122232','MSCRCR97P09F257D','Riccardo','Mescoli','1','1997-09-09','
Modena/Marano s.P/Via Alighieri 7','Modena','0011');
INSERT INTO PAZIENTE VALUES('173221','MRCMTA94P04F257D','MATTEO','MARCHIGNONI','11174984630','1994-01-04', 'Modena', 'Modena', '0022');

INSERT INTO PAZIENTE_RICOVERATO VALUES('173221', '2019-08-12','...','135791','A1','C1',2,2);
INSERT INTO PAZIENTE_RICOVERATO VALUES('122232','2019-07-25','...','232323','A2','C1',1,23);

INSERT INTO PAZIENTE VALUES('176324','SRYDMT94P23Z753D','DIMITRIJ','SKRYPKA','11174864880','1994-09-23', 'Modena', 'Trieste', '0044');
INSERT INTO PAZIENTE_RICOVERATO VALUES(
'176324', '2019-08-20 00:00:', '...', '232323','A2','C1',1,3);

INSERT INTO INFERMIERE VALUES('123456');
INSERT INTO INFERMIERE VALUES('127496');

INSERT INTO TERAPISTA VALUES('654321', 'Psicoterapista');
INSERT INTO TERAPISTA VALUES('137876', 'Fisioterapista');

INSERT INTO TIPOLOGIA_INTERVENTO VALUES('Rinoplastica','..');
INSERT INTO TIPOLOGIA_INTERVENTO VALUES('Bypass coronarico', '...');
INSERT INTO TIPOLOGIA_INTERVENTO VALUES('Artroscopia', '...');


INSERT INTO LISTA_DATTESA VALUES('111111','Rinoplastica');
INSERT INTO LISTA_DATTESA VALUES('111112','Bypass coronarico');
INSERT INTO LISTA_DATTESA VALUES('111131','Artroscopia');



INSERT INTO INSERITO VALUES('122232','111111',NOW());
INSERT INTO INSERITO VALUES('173221','111112','2019-05-01 14:00:00');
INSERT INTO INSERITO VALUES('122232','111112','2019-06-15 17:00:00');

INSERT INTO EQUIPE VALUES('123456');


INSERT INTO INTERVENTO VALUES('2019-02-21 17:00:00','123456','122232','123',2,'123456','ERR','Artroscopia');
INSERT INTO INTERVENTO VALUES('2019-08-7 16:30:00','123456','176324','123',2,'123985','ERR','Artroscopia');



INSERT INTO CHIRURGHI_IN VALUES('232323','123456');
INSERT INTO CHIRURGHI_IN VALUES('135791','123456');
INSERT INTO CHIRURGHI_IN VALUES('024680','123456');

INSERT INTO E_PRIMARIO_DI VALUES('A2','232323');
INSERT INTO E_PRIMARIO_DI VALUES('A1','024680');


INSERT INTO TIPO_TERAPIA VALUES ('Seduta psicoterapeutica', '');
INSERT INTO TIPO_TERAPIA VALUES ('Riabilitazione neurologica', '');



INSERT INTO ABILITATA_A VALUES('P37', 'Seduta psicoterapeutica');

INSERT INTO ABILITATA_A VALUES('321', 'Riabilitazione neurologica');



INSERT INTO TERAPIA VALUES('122232', 'Seduta psicoterapeutica', 5, '16:00:00', 'P37'); 

INSERT INTO TERAPIA VALUES('122232', 'Seduta psicoterapeutica', 2, '16:00:00', 'P37'); 


INSERT INTO TERAPIA VALUES('176324', 'Riabilitazione neurologica', 1,'11:00:00', '321');

INSERT INTO TERAPIA VALUES('176324', 'Riabilitazione neurologica', 3,'15:00:00', '321');

INSERT INTO TERAPIA VALUES('176324', 'Riabilitazione neurologica', 5,'11:00:00', '321');




INSERT INTO DIPENDENTE VALUES('001100','GSPCRT78D14F257J','Giuseppe','Cerrato','340864524','1978-04-14','Modena','Modena','...');

INSERT INTO DIPENDENTE VALUES('001101','NNAGLL68E51F257U','Anna','Gallo','342435678','1968-05-11','Modena','Modena','...');

INSERT INTO DIPENDENTE VALUES('456723','LCUCNT82D22F257A','Luca','Conti','340575612','1982-04-22','Modena','Modena','...');

INSERT INTO INFERMIERE VALUES('001100');
INSERT INTO INFERMIERE VALUES('001101');
INSERT INTO INFERMIERE VALUES('456723');

INSERT INTO STRUMENTISTI_IN VALUES('123456','123456');
INSERT INTO STRUMENTISTI_IN VALUES('456723','123456');
INSERT INTO STRUMENTISTI_IN VALUES('001100','123456');

INSERT INTO TURNO VALUES('123456',1,'...','A2','C1');
INSERT INTO TURNO VALUES('001100',2,'...','A2','C1');
INSERT INTO TURNO VALUES('001101',3,'...','A2','C1');
INSERT INTO TURNO VALUES('456723',4,'...','A2','C1');
INSERT INTO TURNO VALUES('127496',1,'...','A1','C2');
INSERT INTO TURNO VALUES('127496',2,'...','A1','C3');
INSERT INTO TURNO VALUES('127496',5,'...','A1','C2');
INSERT INTO TURNO VALUES('127496',6,'...','A1','C1');
INSERT INTO TURNO VALUES('123456',2,'...','A1','C1');
INSERT INTO TURNO VALUES('123456',4,'...','A2','C3');
INSERT INTO TURNO VALUES('001100',1,'...','A2','C1');
INSERT INTO TURNO VALUES('001100',4,'...','A1','C2');
INSERT INTO TURNO VALUES('001101',6,'...','A2','C3');

INSERT INTO E_CAPOREPARTO_DI VALUES('A1','123456');
INSERT INTO E_CAPOREPARTO_DI VALUES('A2','001100');


INSERT INTO SPECIALIZZAZIONE VALUES('232323',1,'Psichiatria');
INSERT INTO SPECIALIZZAZIONE VALUES('135791',1,'Neurologia');
INSERT INTO SPECIALIZZAZIONE VALUES('024680',1,'Psichiatria');
INSERT INTO SPECIALIZZAZIONE VALUES('232323',2,'Neurologia');
INSERT INTO SPECIALIZZAZIONE VALUES('135791',2,'Neuropsichiatria infantile');
INSERT INTO SPECIALIZZAZIONE VALUES('024680',2,'Endocrinologia e malattie del metabolismo');
INSERT INTO SPECIALIZZAZIONE VALUES('135791',3,'Cardiologia');

INSERT INTO MALATTIA VALUES('A15','Tubercolosi respiratoria, confermata batteriologicamente ed istologicamente');
INSERT INTO MALATTIA VALUES('G30','Malattia di Alzheimer');
INSERT INTO MALATTIA VALUES('G24','Distonia');
INSERT INTO MALATTIA VALUES('I35',' Disturbi non reumatici della valvola aortica');
INSERT INTO MALATTIA VALUES('I33','Endocardite acuta e subacuta');
INSERT INTO MALATTIA VALUES('I74','Embolia e trombosi arteriose');
INSERT INTO MALATTIA VALUES('G20','Morbo di Parkinson');
INSERT INTO MALATTIA VALUES('F18.-','Disturbi psichici e comportamentali dovuti all uso di solventi volatili');
INSERT INTO MALATTIA VALUES('F19.-','Disturbi psichici e comportamentali dovuti all uso di sostanze psicoattive multiple e all uso di altre sostanze psicoattive');
INSERT INTO MALATTIA VALUES('I20','Angina pectoris');
INSERT INTO MALATTIA VALUES('I80','Flebite e tromboflebite');


INSERT INTO PAZIENTE VALUES('122233','RDALSS96P14F231Y','Alessio','Ardu','340292222','1996-04-04','Modena','Modena','0033');

INSERT INTO INSERITO VALUES('122233','111111',NOW());

INSERT INTO HA VALUES('122232','F18.-','Nulla da riportare');
INSERT INTO HA VALUES('173221','I35','Nulla da riportare');
INSERT INTO HA VALUES('173221','G20','Nulla da riportare');
INSERT INTO HA VALUES('122232','G20','Nulla da riportare');

INSERT INTO LABORATORIO VALUES('1111','Analisi chimiche-batteriologiche');

INSERT INTO POSSIEDE VALUES('J0101','01','122232');

INSERT INTO AMBULATORIO VALUES('111111','Otorinolaringoiatria','','A2');
INSERT INTO AMBULATORIO VALUES('222233','Neurologia','','A2');

INSERT INTO SI_OCCUPA_DI VALUES('232323','111111');

INSERT INTO SI_OCCUPA_DI VALUES('135791','222233');

INSERT INTO VISITA VALUES('110011',NOW(),'111111','122233','Visita di controllo');
INSERT INTO REFERTO_DI_ESAME VALUES('110011','Analisi del sangue','...','1111');

INSERT INTO DIPENDENTE VALUES('024681','GCMNGR94P01UOR1Z','Giacomo','Negri','3462136701','1994-07-01','Modena','Modena','...'); 
INSERT INTO DIPENDENTE VALUES('678123','MCLBDO70P01RER2Y','Michael','Boddo','3423451052','1970-07-01','Modena','Modena','...'); 
INSERT INTO DIPENDENTE VALUES('568152','GVNBGT62R01RER1Y','Giovanni','Buongiustino','3423451053','1962-01-23','Modena','Modena','...');
INSERT INTO DIPENDENTE VALUES('568421','MRCGST67R01RER1E','Marco','Giusti','3402956734','1967-04-21','Modena','Modena','...');
INSERT INTO DIPENDENTE VALUES('568431','GCMGRT67R01RCR2E','Giacomo','Giorgietti','3401039254','1967-01-23','Modena','Modena','...');
INSERT INTO DIPENDENTE VALUES('568521','ALSRCT69R01RER1E','Alessandro','Porcu','3422126741','1969-02-28','Modena','Cagliari','...');
INSERT INTO DIPENDENTE VALUES('568621','ODODVD76R01RER1E','Davide','Oddo','3402216402','1976-11-29','Modena','Iglesias','...');
INSERT INTO DIPENDENTE VALUES('568721','ORRFRC77R01RER1E','Franceso','Orrù','32531956543','1977-05-13','Modena','Carbonia','...');

INSERT INTO MEDICO VALUES('024681','LUN-VEN 8:00-16:00','A1');
INSERT INTO MEDICO VALUES('678123','LUN-VEN 8:00-16:00','A1');
INSERT INTO MEDICO VALUES('568152','LUN-VEN 8:00-16:00','A1');
INSERT INTO MEDICO VALUES('568421','LUN-VEN 8:00-16:00','A1');

INSERT INTO TERAPISTA VALUES('568431', 'Psicoterapista');
INSERT INTO TERAPISTA VALUES('568521', 'Fisioterapista');
INSERT INTO TERAPISTA VALUES('568621', 'Psicoterapista');
INSERT INTO TERAPISTA VALUES('568721', 'Fisioterapista');



INSERT INTO VISITA VALUES('332271','2019-10-12 15:15','222233','176324','Visita di verifica');
INSERT INTO REFERTO_DI_ESAME VALUES('332271','Analisi del sangue','...','1111');



INSERT INTO HA VALUES('176324', 'F18.-','Nulla da riportare');


INSERT INTO LABORATORIO VALUES('1234','Laboratorio di Ematologia');
INSERT INTO LABORATORIO VALUES('2345','Laboratorio di Sierologia');
INSERT INTO LABORATORIO VALUES('3456','Laboratorio di Virologia');
INSERT INTO LABORATORIO VALUES('4567','Laboratorio di Radiologia');

INSERT INTO PRENDE VALUES('122232','03862310','1 cpr al giorno');
INSERT INTO PRENDE VALUES('122232','042353021','1 cpr a necessità');
INSERT INTO PRENDE VALUES('176324','03862310','1 cpr al giorno');
INSERT INTO PRENDE VALUES('173221','034706257','1 flacone al giorno');
INSERT INTO PRENDE VALUES('173221','037085089','1 compressa al mattino e una alla sera');



CREATE OR REPLACE FUNCTION dipendenteEsclusivoMedico() RETURNS trigger AS $$
BEGIN
IF EXISTS(SELECT MATRICOLA FROM INFERMIERE I WHERE I.MATRICOLA = NEW.MATRICOLA
UNION
SELECT MATRICOLA FROM TERAPISTA T WHERE T.MATRICOLA = NEW.MATRICOLA) THEN
RAISE EXCEPTION 'IL DIPENDENTE HA GIà UN ALTRA MANSIONE';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_ESCLUSIVITA_DIPENDENTE_m
BEFORE INSERT ON MEDICO
FOR EACH ROW EXECUTE PROCEDURE dipendenteEsclusivoMedico();

CREATE OR REPLACE FUNCTION dipendenteEsclusivoInfermiere() RETURNS trigger AS $$
BEGIN
IF EXISTS(SELECT MATRICOLA FROM MEDICO M WHERE M.MATRICOLA = NEW.MATRICOLA
UNION
SELECT MATRICOLA FROM TERAPISTA T WHERE T.MATRICOLA = NEW.MATRICOLA) THEN
RAISE EXCEPTION 'IL DIPENDENTE HA GIà UN ALTRA MANSIONE';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_ESCLUSIVITA_DIPENDENTE_i
BEFORE INSERT ON INFERMIERE
FOR EACH ROW EXECUTE PROCEDURE dipendenteEsclusivoInfermiere();

CREATE OR REPLACE FUNCTION dipendenteEsclusivoTerapista() RETURNS trigger AS $$
BEGIN
IF EXISTS(SELECT MATRICOLA FROM INFERMIERE I WHERE I.MATRICOLA = NEW.MATRICOLA
UNION
SELECT MATRICOLA FROM MEDICO M WHERE M.MATRICOLA = NEW.MATRICOLA) THEN
RAISE EXCEPTION 'IL DIPENDENTE HA GIà UN ALTRA MANSIONE';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_ESCLUSIVITA_DIPENDENTE_t
BEFORE INSERT ON TERAPISTA
FOR EACH ROW EXECUTE PROCEDURE dipendenteEsclusivoTerapista();

CREATE TRIGGER GESTIONE_ESCLUSIVITA_DIPENDENTE_t_U
BEFORE UPDATE ON TERAPISTA
FOR EACH ROW EXECUTE PROCEDURE dipendenteEsclusivoTerapista();

CREATE TRIGGER GESTIONE_ESCLUSIVITA_DIPENDENTE_m_U
BEFORE UPDATE ON MEDICO
FOR EACH ROW EXECUTE PROCEDURE dipendenteEsclusivoMedico();

CREATE TRIGGER GESTIONE_ESCLUSIVITA_DIPENDENTE_i_U
BEFORE UPDATE ON INFERMIERE
FOR EACH ROW EXECUTE PROCEDURE dipendenteEsclusivoInfermiere();

CREATE OR REPLACE FUNCTION inserimentoIntervento() RETURNS trigger AS $$
BEGIN
DELETE FROM INSERITO I WHERE I.CODICE_LISTA IN (SELECT CODICE_LISTA FROM LISTA_DATTESA L WHERE L.DENOM_TIPO = NEW.DENOM_TIPO) AND I.COD_PAZIENTE = NEW.COD_PAZIENTE;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_INSERIMENTO_INTERVENTO
AFTER INSERT ON INTERVENTO
FOR EACH ROW EXECUTE PROCEDURE inserimentoIntervento();

CREATE OR REPLACE FUNCTION inserimentoTerapia() RETURNS trigger AS $$
BEGIN

IF NEW.NOME_TERAPIA NOT IN (SELECT NOME_TERAPIA FROM ABILITATA_A WHERE CODICE_SALA = NEW.CODICE_SALA)
THEN
RAISE EXCEPTION 'SALA NON ABILITATA A QUESTO TIPO DI TERAPIA';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_INSERIMENTO_TERAPIA
AFTER INSERT ON TERAPIA
FOR EACH ROW EXECUTE PROCEDURE inserimentoTerapia();


CREATE OR REPLACE FUNCTION inserimento_intervento(DATA DATE, CODICE_EQUIPE CHAR(6), COD_PAZIENTE CHAR(6), CODICE_SALA CHAR(3), FASCIA_ORARIA INT, COD_INTERVENTO CHAR(6), DESCRIZIONE TEXT, DENOM_TIPO CHAR(25)) 
    RETURNS VOID AS $$
    BEGIN
      INSERT INTO INTERVENTO VALUES (DATA, CODICE_EQUIPE, COD_PAZIENTE, CODICE_SALA, FASCIA_ORARIA, COD_INTERVENTO, DESCRIZIONE, DENOM_TIPO);
    END;
    $$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION salaOperatoriaEsclusiva() RETURNS trigger AS $$
BEGIN
IF EXISTS(SELECT CODICE_SALA FROM SALA_TERAPEUTICA S WHERE S.CODICE_SALA = NEW.CODICE_SALA) THEN
RAISE EXCEPTION 'SALA GIà APPARTENENTE AD UN ALTRA TIPOLOGIA';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_ESCLUSIVITA_SALA_o
BEFORE INSERT ON SALA_OPERATORIA
FOR EACH ROW EXECUTE PROCEDURE salaOperatoriaEsclusiva();

CREATE OR REPLACE FUNCTION salaTerapeuticaEsclusiva() RETURNS trigger AS $$
BEGIN
IF EXISTS(SELECT CODICE_SALA FROM SALA_OPERATORIA S WHERE S.CODICE_SALA = NEW.CODICE_SALA) THEN
RAISE EXCEPTION 'SALA GIà APPARTENENTE AD UN ALTRA TIPOLOGIA';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER GESTIONE_ESCLUSIVITA_SALA_t
BEFORE INSERT ON SALA_TERAPEUTICA
FOR EACH ROW EXECUTE PROCEDURE salaTerapeuticaEsclusiva();

CREATE TRIGGER GESTIONE_ESCLUSIVITA_SALA_o_U
BEFORE UPDATE ON SALA_OPERATORIA
FOR EACH ROW EXECUTE PROCEDURE salaOperatoriaEsclusiva();

CREATE TRIGGER GESTIONE_ESCLUSIVITA_SALA_t_U
BEFORE UPDATE ON SALA_TERAPEUTICA
FOR EACH ROW EXECUTE PROCEDURE salaTerapeuticaEsclusiva();


CREATE OR REPLACE FUNCTION inserimento_terapia(COD_PAZIENTE CHAR(6), NOME_TERAPIA VARCHAR(100), GIORNO_SETT INT, ORA TIME, CODICE_SALA CHAR(3)) 
    RETURNS VOID AS $$
    BEGIN
      INSERT INTO TERAPIA VALUES (COD_PAZIENTE, NOME_TERAPIA, GIORNO_SETT, ORA, CODICE_SALA);
    END;
    $$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION vincolo_data_referti() RETURNS trigger AS $$
BEGIN
IF NOW() < (SELECT DATA_ORA FROM VISITA V WHERE V.CODICE_VISITA = NEW.CODICE_VISITA ) THEN
RAISE EXCEPTION 'VISITA NON ANCORA AVVENUTA';
END IF;
RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER VINCOLO_REFERTI
BEFORE INSERT ON REFERTO_DI_ESAME
FOR EACH ROW EXECUTE PROCEDURE vincolo_data_referti();


CREATE OR REPLACE FUNCTION lista_pazienti_medico (MATRICOLA_M CHAR(6)) 
   RETURNS TABLE (
      COD_PAZ CHAR(6)
)
AS $$
BEGIN
   RETURN QUERY SELECT
      COD_PAZIENTE
   FROM
      PAZIENTE_RICOVERATO
   WHERE
      MATRICOLA = MATRICOLA_M ;
END; $$ 
 
LANGUAGE 'plpgsql';







CREATE OR REPLACE FUNCTION lista_terapie_paziente (COD_PAZ CHAR(6)) 
   RETURNS TABLE (
      NOME_TER VARCHAR(100)
) 
AS $$
BEGIN
   RETURN QUERY SELECT
      NOME_TERAPIA
   FROM
      TERAPIA
   WHERE
      COD_PAZIENTE = COD_PAZ ;
END; $$ 
 
LANGUAGE 'plpgsql';


CREATE OR REPLACE FUNCTION sale_op_equivalenti (CODICE_SALA_E CHAR(3)) 
   RETURNS TABLE (
      COD_SALA CHAR(3)
) 
AS $$
BEGIN
   RETURN QUERY SELECT CODICE_SALA
   FROM SALA_OPERATORIA SO1
   WHERE SO1.CODICE_SALA <> CODICE_SALA_E
    AND  NOT EXISTS(
        SELECT *
        FROM STRUMENTAZIONE_CHIRURGICA SC2
        WHERE SC2.CODICE_SALA = CODICE_SALA_E 
        AND NOT EXISTS(
            SELECT * 
            FROM STRUMENTAZIONE_CHIRURGICA SC1
            WHERE SO1.CODICE_SALA = SC1.CODICE_SALA AND SC1.CODICE_CND = 
            SC2.CODICE_CND));
END; $$ 
 
LANGUAGE 'plpgsql';










CREATE OR REPLACE FUNCTION lista_medicine_paziente (COD_PAZ CHAR(6)) 
   RETURNS TABLE (
      COD_AIC_R CHAR(9),
      COD_ATC_R CHAR(7),
      NOME_R VARCHAR(30),
      DOSAGGIO_R VARCHAR
) 
AS $$
BEGIN
   RETURN QUERY SELECT
      M.COD_AIC, COD_ATC, NOME, DOSAGGIO
   FROM
      MEDICINA M, PRENDE PR
   WHERE
      P.COD_PAZIENTE = COD_PAZ AND P.COD_AIC = M.COD_AIC ;
END; $$ 
 
LANGUAGE 'plpgsql';


CREATE OR REPLACE FUNCTION lista_dattesa (COD_LISTA CHAR(6)) 
   RETURNS TABLE (
      COD_PAZIENTE_I CHAR(6),
      DATA_INS_I DATE
) 
AS $$
BEGIN
   RETURN QUERY SELECT
      COD_PAZIENTE, DATA_INS
   FROM
      INSERITO I
   WHERE
      I.CODICE_LISTA = COD_LISTA
   ORDER BY DATA_INS ASC ;
END; $$ 
 
LANGUAGE 'plpgsql';


CREATE OR REPLACE FUNCTION lista_impiantabili_paziente (COD_PAZ CHAR(6)) 
   RETURNS TABLE (
      COD_CND CHAR(9),
      COD_SERIALE CHAR(20)
) 
AS $$
BEGIN
   RETURN QUERY SELECT
      CODICE_CND, CODICE_SERIALE
   FROM
      POSSIEDE P
   WHERE
      P.COD_PAZIENTE = COD_PAZ;
END; $$ 
 
LANGUAGE 'plpgsql';



CREATE OR REPLACE FUNCTION malattia_piu_diffusa()
RETURNS TABLE(
       COD_ICD10_M CHAR(5),
       MALATI BIGINT
       )
AS $$
BEGIN
RETURN QUERY
     SELECT COD_ICD10, COUNT(*) AS MALATI
     FROM HA HA1
     GROUP BY HA1.COD_ICD10
     HAVING COUNT(*) >= ALL(
   	 	  SELECT COUNT(*)
    		  FROM HA HA2
    		  GROUP BY HA2.COD_ICD10);
   END; $$ 
 
LANGUAGE 'plpgsql';




CREATE OR REPLACE FUNCTION letti_liberi_per_reparto()
RETURNS TABLE(
       COD_REP CHAR(2),
       LETTI_LIBERI BIGINT
       )
AS $$
BEGIN
RETURN QUERY
   SELECT L.COD_REPARTO, COUNT(*)
   FROM LETTO L
   WHERE NOT EXISTS(
      SELECT *
      FROM PAZIENTE_RICOVERATO PR
      WHERE L.COD_REPARTO = PR.COD_REPARTO 
      AND  L.CODICE_CORSIA = PR.CODICE_CORSIA
      AND L.NUM_STANZA = PR.NUM_STANZA
      AND L.NUM_LETTO = PR.NUM_LETTO)
      GROUP BY L.COD_REPARTO;

   END; $$ 
 
LANGUAGE 'plpgsql';

CREATE OR REPLACE FUNCTION inserimento_visita(CODICE_VISITA CHAR(6), DATA_ORA TIMESTAMP, COD_AMB CHAR(6), COD_PAZIENTE CHAR(6), DESCRIZIONE VARCHAR) 
    RETURNS VOID AS $$
    BEGIN
      INSERT INTO VISITA VALUES (CODICE_VISITA, DATA_ORA, COD_AMB, 
 COD_PAZIENTE, DESCRIZIONE);
    END;
    $$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION inserimento_referto(CODICE_VISITA CHAR(6), TIPO_ESAME VARCHAR(150), DESCRIZIONE VARCHAR, COD_LAB CHAR(4)) 
    RETURNS VOID AS $$
    BEGIN
      INSERT INTO REFERTO_DI_ESAME VALUES (CODICE_VISITA, TIPO_ESAME, DESCRIZIONE, COD_LAB);
    END;
    $$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION visite_medico_periodo(MATR_M CHAR(6), DATA_ORA_MIN TIMESTAMP)
RETURNS TABLE(
       CODICE_VISITA_R CHAR(6),
       DATA_ORA_R TIMESTAMP,
       COD_AMB_R CHAR(6),
       COD_PAZIENTE_R CHAR(6),
       DESCRIZIONE_R VARCHAR
       )
AS $$
BEGIN
RETURN QUERY
      SELECT V.*
      FROM SI_OCCUPA_DI SOD, VISITA V
      WHERE SOD.MATRICOLA = MATR_M
      AND SOD.COD_AMB = V.COD_AMB
      AND V.DATA_ORA >= DATA_ORA_MIN;

  END; $$ 
 
LANGUAGE 'plpgsql';




